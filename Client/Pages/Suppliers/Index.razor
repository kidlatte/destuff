@page "/suppliers"

@attribute [Authorize]
@inject NavigationManager Nav
@inject IHttpService Http
@inject IDialogService Dialog

<PageTitle>Suppliers | Destuff</PageTitle>

<MudText Typo="Typo.h1" Class="my-5">Suppliers</MudText>

<MudDataGrid @ref="grid" T="SupplierListItem" ServerData="LoadServerData" CurrentPage="gridPage" RowsPerPage="PageSize" Loading="loading" SortMode="SortMode.Single">
    <ToolBarContent>
        <MudTextField T="string" Value="search" ValueChanged="OnSearch" Placeholder="Search"
                      Style="max-width: 300px" Clearable="true" Variant="Variant.Outlined" Margin="Margin.Dense"
                      Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium"></MudTextField>
        <MudSpacer />
        <MudButton OnClick="OnAddClick" Variant="Variant.Filled" Color="Color.Primary" Class="mr-2">Add</MudButton>
    </ToolBarContent>
    <Columns>
        <PropertyColumn Property="x => x!.ShortName">
            <CellTemplate>
                <MudLink Href="@($"/suppliers/{context.Item?.Slug}")">@context.Item?.ShortName</MudLink>
            </CellTemplate>
        </PropertyColumn>
        <PropertyColumn Property="x => x!.Name">
            <CellTemplate>
                @if (context.Item != null)
                {
                    <text>@context.Item.Name</text>
                }
            </CellTemplate>
        </PropertyColumn>
        <TemplateColumn Title="Contact" Sortable="false">
            <CellTemplate>
                @if (context.Item != null)
                {
                    @if (!string.IsNullOrEmpty(context.Item.Phone))
                    {
                        <text>@context.Item.Phone</text>
                    }

                    @if (!string.IsNullOrEmpty(context.Item.Url))
                    {
                        <MudLink Href="@context.Item.Url" Target="_blank">
                            <text>@(new Uri(context.Item.Url).Host.Replace("www.", ""))</text>
                        </MudLink>
                    }
                }
            </CellTemplate>
        </TemplateColumn>
        <TemplateColumn Sortable="false">
            <CellTemplate>
                @if (context.Item != null)
                {
                    <MudIconButton OnClick="_ => OnDelete(context.Item)" Icon="@Icons.Material.Filled.Delete" aria-label="delete"></MudIconButton>
                }
            </CellTemplate>
        </TemplateColumn>
    </Columns>
    <PagerContent>
        <div class="py-5 d-flex justify-center">
            @if (PageCount > 1)
            {
                <MudPagination Count="PageCount" Selected="pagerPage" SelectedChanged="PageChanged" Color="Color.Primary" />
            }
        </div>
    </PagerContent>
</MudDataGrid>

<DeleteModal @ref="delete" OnDeleted="LoadData" />

@code
{
    [Parameter, SupplyParameterFromQuery(Name = "s")]
    public string? Search { get; set; }
    public string? search { get; set; }

    [Parameter, SupplyParameterFromQuery(Name = "p")]
    public int? Page { get; set; } = 1;
    int gridPage => (Page ?? 1) - 1;
    int pagerPage = 1;

    int PageSize => 10;
    int PageCount;
    bool loading;

    PagedList<SupplierListItem>? data { get; set; }
    
    DeleteModal? delete;

    MudDataGrid<SupplierListItem>? grid;

    protected async override Task OnParametersSetAsync()
    {
        search = Search;
        await LoadData();
    }

    async Task LoadData()
    {
        var query = new PagedQuery { Search = Search, Page = Page, PageSize = PageSize };
        data = await Http.GetAsync<PagedList<SupplierListItem>>($"{ApiRoutes.Suppliers}?{query}");
    }

    async Task<GridData<SupplierListItem>> LoadServerData(GridState<SupplierListItem> state)
    {
        var sort = state.SortDefinitions.FirstOrDefault();
        var query = new PagedQuery
            {
                Search = Search,
                Page = gridPage, // BUG: state returns wrong page on first load.
                PageSize = state.PageSize,
                SortField = sort?.SortBy,
                SortDir = sort?.Descending == true ? DestuffDirection.Descending : DestuffDirection.Ascending
            };

        loading = true;
        var result = await Http.GetAsync<PagedList<SupplierListItem>>($"{ApiRoutes.Suppliers}?{query}");
        loading = false;

        if (result == null)
            throw new Exception("Result is null");

        PageCount = (result.Count - 1) / PageSize + 1;
        return new()
            {
                Items = result.List,
                TotalItems = result.Count
            };
    }

    string GenerateLink(int page) => $"/suppliers?{new PagedQuery { Search = Search, Page = page }}";

    void OnSearch() => Nav.NavigateTo($"/suppliers?s={search}");

    void PageChanged(int i)
    {
        if (pagerPage != i)
            Nav.NavigateTo($"/suppliers?{new PagedQuery { Search = Search, Page = i }}");
        pagerPage = i;
    }

    async void OnAddClick()
    {
        var parameters = new DialogParameters();
        parameters.Add(nameof(SupplierCreateModal.Model), new SupplierRequest());

        var dialog = await Dialog.ShowAsync<SupplierCreateModal>("", parameters);
        var result = await dialog.Result;
        if (!result.Canceled && grid != null)
            await grid.ReloadServerData();
    }

    async void OnDelete(SupplierListItem item)
    {
        var parameters = new DialogParameters();
        parameters.Add(nameof(DeleteModal.Model), item);

        var dialogRef = await Dialog.ShowAsync<DeleteModal>("", parameters);
        var result = await dialogRef.Result;

        if (!result.Canceled && grid != null)
            await grid.ReloadServerData();
    }
}