@inject IHttpService Http
@inject IDialogService Dialog

<MudAutocomplete @ref="field" @bind-Text="text" T="IStuffModel"
                 Value="Model" ValueChanged="ModelChanged"
                 SearchFunc="@Search" ToStringFunc="@(x => x.Name)" Disabled="Disabled"
                 Label="Stuff" Variant="Variant.Outlined"
                 Clearable="true" ResetValueOnEmptyText="true" ShowProgressIndicator="true">
</MudAutocomplete>

@code
{
    [Parameter] public string? Value { get; set; }
    [Parameter] public EventCallback<string?> ValueChanged { get; set; }
    [Parameter] public bool Disabled { get; set; }

    IEnumerable<IStuffModel> list { get; set; } = Enumerable.Empty<IStuffModel>();
    IStuffModel? Model { get; set; }
    string? text { get; set; }

    MudAutocomplete<IStuffModel>? field;

    protected override void OnParametersSet() => SetModel();

    void SetModel() => Model = list.FirstOrDefault(x => x.Id == Value);

    async Task<IEnumerable<IStuffModel>> Search(string value)
    {
        var query = new PagedQuery { Search = value, PageSize = 9 };
        var result = await Http.GetAsync<PagedList<StuffListItem>>($"{ApiRoutes.Stuffs}?{query}");

        list = result?.List.ToList() ?? Enumerable.Empty<StuffListItem>();
        SetModel();

        return list.Append(new StuffListItem { Id = "add", Slug = "add", Name = "-- Create new Stuff --" });
    }

    private async Task ModelChanged(IStuffModel? value)
    {
        if (value?.Id == "add" && field != null)
        {
            await field.ToggleMenu(); // close dropdown
            var model = await CreateNewStuff();

            await field.Clear();
            await field.ToggleMenu(); // force search

            if (ValueChanged.HasDelegate)
                await ValueChanged.InvokeAsync(model?.Id);

            text = model?.Name;
        }
        else
        {
            Model = value;
            if (ValueChanged.HasDelegate)
                await ValueChanged.InvokeAsync(value?.Id);
        }
    }

    async Task<IStuffModel?> CreateNewStuff()
    {
        var dialog = await Dialog.ShowAsync<StuffCreateModal>();
        var result = await dialog.Result;

        if (result.Canceled)
            return null;

        return result.Data as IStuffModel;
    }
}